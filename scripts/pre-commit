#!/bin/bash
# pre-commit hook for Svelte section validation
# Copy to .git/hooks/pre-commit and make executable

set -e

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'

# Get staged .svelte files
STAGED_SVELTE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.svelte$' || true)

if [[ -z "$STAGED_SVELTE_FILES" ]]; then
	exit 0
fi

echo -e "${YELLOW}Checking Svelte section order...${NC}"

# Section order
SECTIONS=("IMPORTS" "TYPES" "PROPS" "STATE" "DERIVED" "EFFECTS" "FUNCTIONS")

has_errors=0

for file in $STAGED_SVELTE_FILES; do
	# Skip UI components
	if [[ "$file" == *"/components/ui/"* ]]; then
		continue
	fi

	found_sections=()
	line_numbers=()
	line_num=0

	while IFS= read -r line || [[ -n "$line" ]]; do
		((line_num++))
		for section in "${SECTIONS[@]}"; do
			if [[ "$line" =~ ^[[:space:]]*//[[:space:]]*=*[[:space:]]*${section}[[:space:]]*=*[[:space:]]*$ ]]; then
				found_sections+=("$section")
				line_numbers+=("$line_num")
			fi
		done
	done < "$file"

	# Check order
	prev_index=-1
	for i in "${!found_sections[@]}"; do
		section="${found_sections[$i]}"
		for j in "${!SECTIONS[@]}"; do
			if [[ "${SECTIONS[$j]}" == "$section" ]]; then
				if [[ $j -lt $prev_index ]]; then
					echo -e "${RED}ERROR${NC}: $file"
					echo -e "  ${YELLOW}→${NC} '$section' is out of order at line ${line_numbers[$i]}"
					has_errors=1
				fi
				prev_index=$j
				break
			fi
		done
	done
done

if [[ $has_errors -eq 1 ]]; then
	echo ""
	echo -e "${RED}Commit blocked: Fix section order${NC}"
	echo "Expected: IMPORTS → TYPES → PROPS → STATE → DERIVED → EFFECTS → FUNCTIONS"
	exit 1
fi

echo -e "${GREEN}Svelte sections OK${NC}"
exit 0
